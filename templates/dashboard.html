<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="utf-8">
    <title>أمان أبشر - لوحة التحكم</title>

    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body class="absher-bg">

<!-- LANGUAGE BAR -->
<div class="lang-switch">
    <button type="button" onclick="setLang('ar')">العربية</button>
    <button type="button" onclick="setLang('en')">English</button>

    <form action="/logout" method="POST" style="display: inline;">
        <button class="logout-btn"
                data-ar="تسجيل الخروج"
                data-en="Logout">
            تسجيل الخروج
        </button>
    </form>
</div>

<div class="page-wrapper">
    <div class="dashboard-shell">

        <!-- HEADER -->
        <header class="dash-header">
            <div class="logo-row">
                <img src="{{ url_for('static', filename='logo.png') }}" class="logo-small" alt="logo">
                <span class="app-name" data-ar="أمان أبشر" data-en="Aman Absher"></span>
            </div>
            <div class="user-badge">
                <span class="avatar-circle">U</span>
                <span class="user-name">{{ session.get('username', 'User') }}</span>
            </div>
        </header>

        {% if attempt %}
        <main class="dash-main-two">

            <!-- LEFT SECTION -->
            <section class="card-half">

                <h2 class="card-title"
                    data-ar="موقع تسجيل الدخول"
                    data-en="Login Location"></h2>

                <!-- MAP -->
                <div class="zone-map" id="zone-map">
                    {% set lat = attempt.latitude or '24.7136' %}
                    {% set lon = attempt.longitude or '46.6753' %}

                    <iframe
                        class="zone-map-iframe"
                        loading="lazy"
                        src="https://www.google.com/maps?q={{ lat }},{{ lon }}&z=15&output=embed">
                    </iframe>

                    <div class="zone-map-rings"></div>
                    <div class="zone-map-marker"></div>

                    <div class="zone-map-info"
                         data-ar="موقع تسجيل الدخول الحالي"
                         data-en="Current login location"></div>
                </div>

                <!-- DEVICE INFO -->
                <div class="device-info-list">
                    <h3 data-ar="معلومات الجهاز الحالية" data-en="Current Device Information"></h3>
                    <ul>
                        <li><strong>IP:</strong> {{ attempt.ip }}</li>
                        <li><strong data-ar="الدولة" data-en="Country"></strong>: {{ attempt.country }}</li>
                        <li><strong data-ar="المدينة" data-en="City"></strong>: {{ attempt.city }}</li>
                        <li><strong data-ar="الإحداثيات" data-en="Coordinates"></strong>:
                            {{ attempt.latitude }}, {{ attempt.longitude }}</li>
                        <li><strong data-ar="نوع الجهاز" data-en="Device type"></strong>: {{ attempt.device_type }}</li>
                        <li><strong data-ar="نظام التشغيل" data-en="OS"></strong>: {{ attempt.os }}</li>
                        <li><strong data-ar="المتصفح" data-en="Browser"></strong>: {{ attempt.browser }}</li>
                        <li><strong data-ar="الذاكرة" data-en="RAM"></strong>: {{ attempt.ram }}</li>
                        <li><strong data-ar="المعالج" data-en="CPU"></strong>: {{ attempt.cpu }}</li>
                        <li><strong>GPU:</strong> {{ attempt.gpu_vendor }} / {{ attempt.gpu_model }}</li>
                        <li><strong data-ar="دقة الشاشة" data-en="Screen"></strong>: {{ attempt.screen }}</li>
                        <li><strong>Canvas FP:</strong> {{ attempt.canvas_fp[:60] }}...</li>
                    </ul>
                </div>

            </section>

            <!-- RIGHT SECTION -->
            <section class="card-half">

                <h2 class="card-title"
                    data-ar="ملخص مستوى الأمان"
                    data-en="Security Summary"></h2>

                <div class="risk-summary-box">
                    <p><span data-ar="آخر تسجيل دخول" data-en="Last login"></span>:
                        <strong>{{ attempt.timestamp }}</strong></p>

                    <p><span data-ar="درجة المخاطر" data-en="Risk score"></span>:
                        <strong>{{ attempt.risk_score }}</strong></p>

                    <p><span data-ar="مستوى المخاطر" data-en="Risk level"></span>:
                        <strong>{{ attempt.risk_level }}</strong></p>

                    {% set safe_score = attempt.risk_score if attempt.risk_score <= 100 else 100 %}

                    <div class="risk-bar-container">
                        <div class="risk-bar">
                            <div class="risk-bar-fill" data-width="{{ safe_score }}"></div>
                        </div>
                    </div>

                    <p class="risk-note"
                       data-ar="هذه النتيجة تعتمد على اختلاف موقعك وجهازك وشبكتك مقارنة بالأول."
                       data-en="This score is based on changes in device, network, and location."></p>
                </div>

                <div class="extra-notes">
                    <h3 data-ar="تفاصيل إضافية" data-en="Additional Info"></h3>
                    <ul>
                        <li><span data-ar="نوع الشبكة" data-en="Network"></span>: {{ attempt.network_type }}</li>
                        <li><span data-ar="المنطقة الزمنية" data-en="Timezone"></span>: {{ attempt.timezone }}</li>
                        <li><span data-ar="لغة المتصفح" data-en="Language"></span>: {{ attempt.language }}</li>
                    </ul>
                </div>


                <!-- ⭐⭐⭐ SAVED SECURITY ZONES (MOVED HERE) ⭐⭐⭐ -->
                <div class="card" style="margin-top: 25px; padding:20px; border-radius:12px; background:#fff;">

                    <h3 class="card-title" data-ar="مناطق الأمان المحفوظة" data-en="Saved Security Zones"></h3>

                    <!-- Zone Name Input -->
                    <input type="text" id="zoneName" class="input-zone-name"
                           placeholder="اسم المنطقة (المنزل، العمل)" />

                    <!-- Save Button -->
                    <button class="primary-btn"
                            onclick="saveZone()"
                            data-ar="إضافة منطقة أمان"
                            data-en="Add Security Zone">
                        إضافة منطقة أمان
                    </button>

                    <div style="margin-top:15px;">

                        {% if zones|length == 0 %}
                            <p style="font-size:13px;color:#777;">لا توجد مناطق محفوظة.</p>
                        {% endif %}

                        {% for z in zones %}
                        <div class="saved-zone-card" id="zone-{{ z.id }}"
                             style="padding:12px;border:1px solid #ddd;border-radius:12px;margin-bottom:12px;background:#fafafa;">

                            <div style="display:flex;justify-content:space-between;align-items:center;">
                                <strong>{{ z.name }}</strong>

                                <button class="delete-zone-btn" onclick="deleteZone('{{ z.id }}')">✕</button>

                            </div>

                            <iframe class="zone-map-iframe"
                                style="margin-top:10px;border-radius:12px;height:180px;width:100%;"
                                src="https://www.google.com/maps?q={{ z.latitude }},{{ z.longitude }}&z=16&output=embed">
                            </iframe>

                            <small style="color:#555">
                                Lat: {{ z.latitude }} <br>
                                Lon: {{ z.longitude }}
                            </small>

                        </div>
                        {% endfor %}

                    </div>

                </div>
                <!-- END SAVED ZONES -->

            </section>

        </main>
        {% endif %}

        <p class="disclaimer small"
           data-ar="هذا النموذج لأغراض تعليمية فقط وغير تابع لمنصة أبشر."
           data-en="This is a demo interface for educational purposes only.">
        </p>
    </div>
</div>


<!-- JS -->
<script>

function saveZone() {
    const name = document.getElementById("zoneName").value.trim();
    if (name === "") return alert("اكتب اسم المنطقة");

    fetch("/add_zone", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({ name: name })
    })
    .then(r => r.json())
    .then(data => {
        if (data.status === "limit_reached") {
            alert("تم الوصول للحد الأقصى (3 مناطق)");
            return;
        }
        location.reload();
    });
}


function deleteZone(id) {
    fetch(`/delete_zone/${id}`, {
        method: "POST"
    })
    .then(r => r.json())
    .then(data => {
        if (data.status === "deleted") {
            const card = document.getElementById("zone-" + id);
            if (card) card.remove();
        }
    });
}


function setLang(lang) {
    const root = document.documentElement;
    root.lang = lang;
    root.dir = (lang === "ar") ? "rtl" : "ltr";

    document.querySelectorAll("[data-ar]").forEach(el => {
        el.textContent = (lang === "ar")
            ? el.getAttribute("data-ar")
            : el.getAttribute("data-en");
    });
}

window.onload = function () {
    setLang("ar");

    document.querySelectorAll('.risk-bar-fill').forEach(el => {
        el.style.width = el.getAttribute("data-width") + "%";
    });
};

</script>

</body>
</html>
